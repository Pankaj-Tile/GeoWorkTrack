<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" th:replace="normal/base::layout(~{::section})">
<head>
    <meta charset="ISO-8859-1">
    <title>This is the About</title>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <!-- SweetAlert CSS and JS -->
    <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
</head>
<body>
<section>
    <div class="container">
        <div class="card">
            <div class="card-body">
                <h1 class="text-center mt-3" th:text="${user.username}"></h1>
                <div id="statusMessage" style="color: red;"></div>
                <div id="map" style="height: 400px;"></div>
                <button id="toggleLocation" style="padding: 10px 20px; font-size: 16px;">Start Sharing Location</button>
            </div>
        </div>
    </div>

    <script>
        var map = L.map('map').setView([19.9975, 73.7898], 13); // Initialize map
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
        }).addTo(map);

        var userMarker;
        var userId = [[${user.userId}]]; // Thymeleaf variable
        console.log(userId);
        var watchId;
        var isSharingLocation = false;
        var socket;
        var toggleButton = document.getElementById('toggleLocation');
        var statusMessage = document.getElementById('statusMessage');
        var socketConnectionAttempted = false;

        function connectWebSocket() {
            // Initialize WebSocket
            socket = new WebSocket("ws://localhost:8080/ws");
            socket.onopen = function () {
                console.log("WebSocket connection opened");
                statusMessage.textContent = "WebSocket connection successful!";
                socketConnectionAttempted = true;
            };
            socket.onmessage = function (event) {
                console.log("Message received from WebSocket:", event.data);
                var data = JSON.parse(event.data);
                if (data.message) {
                    // Display SweetAlert message
                    swal({
                        title: "Alert",
                        text: data.message,
                        icon: "warning",
                    });
                } else {
                    updateMarkers(data); // Update the map with location data
                }
            };
            socket.onerror = function (error) {
                console.error("WebSocket error:", error);
                statusMessage.textContent = "Error: WebSocket connection failed!";
            };
            socket.onclose = function (event) {
                console.log("WebSocket connection closed", event);
                if (event.wasClean) {
                    statusMessage.textContent = "WebSocket closed cleanly.";
                } else {
                    statusMessage.textContent = "WebSocket connection unexpectedly closed!";
                }
                console.log("Close event code: ", event.code, "Reason: ", event.reason);
            };
        }

        function checkWebSocketStateAndSend(data) {
            if (!socketConnectionAttempted) {
                console.warn("WebSocket has not been initialized. Attempting to connect...");
                statusMessage.textContent = "Attempting to connect WebSocket...";
                connectWebSocket();
            } else if (socket.readyState === WebSocket.OPEN) {
                console.log("Sending data:", data);
                socket.send(JSON.stringify(data));
            } else if (socket.readyState === WebSocket.CONNECTING) {
                console.warn("WebSocket is still connecting. Please wait...");
                statusMessage.textContent = "WebSocket connecting...";
            } else {
                console.error("WebSocket is not open. Current state:", socket.readyState);
                statusMessage.textContent = "WebSocket connection not open.";
            }
        }

        toggleButton.addEventListener('click', function () {
            if (isSharingLocation) {
                stopSharingLocation();
            } else {
                startSharingLocation();
            }
        });

        function startSharingLocation() {
            if ("geolocation" in navigator) {
                navigator.geolocation.getCurrentPosition(function (position) {
                    watchId = navigator.geolocation.watchPosition(function (position) {
                        var lat = position.coords.latitude;
                        var lon = position.coords.longitude;
                        if (!userMarker) {
                            userMarker = L.circleMarker([lat, lon], { color: 'blue' }).addTo(map);
                            map.setView([lat, lon], 13);
                        } else {
                            userMarker.setLatLng([lat, lon]);
                        }
                        var locationData = {
                            userId: userId,
                            latitude: lat,
                            longitude: lon,
                            timestamp: new Date().toISOString()
                        };
                        checkWebSocketStateAndSend(locationData); // Check WebSocket state before sending data
                    }, function (error) {
                        console.error("Error getting location: ", error.message);
                        alert("Error getting location: " + error.message);
                    }, {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    });
                    isSharingLocation = true;
                    toggleButton.textContent = 'Stop Sharing Location';
                }, function (error) {
                    alert("Location access denied: " + error.message);
                });
            } else {
                alert("Geolocation is not available in this browser.");
            }
        }

        function stopSharingLocation() {
            if (watchId) {
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
            }
            if (socket.readyState === WebSocket.OPEN) {
                socket.send(JSON.stringify({ action: 'removeLocation', userId: userId }));
            }
            isSharingLocation = false;
            toggleButton.textContent = 'Start Sharing Location';
        }

        function updateMarkers(data) {
            data.forEach(function (location) {
                var lat = location.latitude;
                var lon = location.longitude;
                if (!userMarker) {
                    userMarker = L.circleMarker([lat, lon], { color: 'green' }).addTo(map);
                } else {
                    userMarker.setLatLng([lat, lon]);
                }
            });
        }

        // Attempt to connect WebSocket on page load
        connectWebSocket();

        // Periodically fetch other users' locations
        setInterval(function () {
            if (socket.readyState === WebSocket.OPEN) {
                socket.send(JSON.stringify({ action: 'fetchLocations' }));
            }
        }, 1000);
    </script>
</section>
</body>
</html>
